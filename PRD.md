# Easy-SQL 引擎 - PRD（产品需求文档）

## 1. 背景与问题
- 现状：面对多变复杂查询（报表分析、日志分析、用户行为与画像、多维分析、大促与广告埋点等），传统CRUD接口难以覆盖，业务层代码复杂、扩展慢，无法支撑分析部门的高频变化需求。
- 影响：需求从提出到交付耗时长，数据分析时效性不足，间接影响决策效率。
- 目标：提供一个“通用可扩展”的SQL引擎基础设施，支持以JSON模板或对象组合方式快速产出高性能SQL与可执行结果，最大化减少业务层编码工作量，提升交付速度与可维护性。

## 2. 产品定位与价值
- 定位：轻量、通用、高性能的动态SQL生成与执行引擎（SDK优先，可选Server化）。
- 价值：
  - 低门槛：不需要建立实体模型；用JSON或对象组合描述查询即可。
  - 高灵活：随业务维度变化快速组装复杂查询（过滤、聚合、分组、嵌套、窗口、分页等）。
  - 高性能：精简结构、参数化执行、可选缓存与连接复用。
  - 可治理：提供模板校验、白名单、限流、审计、指标监控。

## 3. 目标用户与使用场景
- 用户画像：
  - 数据分析师/数仓同学：编写查询模板驱动报表与探索性分析。
  - 业务后端工程师：以SDK/HTTP调用形式，按需拼装复杂查询接口。
  - 运维/平台工程师：统一治理、监控、配额与审计。
- 典型场景：
  - BI/报表：多维聚合、钻取、分组排序、分页。
  - 日志分析：按时间/服务/地区过滤汇总，大窗口滚动统计。
  - 用户行为：事件明细、漏斗、留存、分群、画像指标。
  - 营销/促销：实时拉取活动命中、曝光/点击/转化等汇总。
  - 广告埋点：多表join与维表补充，分区扫描。

## 4. 核心功能需求（Must/Should/Could）
- Must
  - 支持JSON模板描述查询（select、from、join、where、groupBy、having、orderBy、limit/offset、union/unionAll）。
  - 支持对象组合DSL（用于强类型与IDE补全的开发体验）。
  - 参数化SQL生成（防注入、可缓存、复用预编译）。
  - 多SQL方言适配基础能力（至少MySQL/ClickHouse/PostgreSQL优先一种，按里程碑推进）。
  - 模板校验（结构、类型、必填项、注入风险）。
  - 元数据探查（表、列、类型）与本地/远端缓存。
  - 统一执行器（DataSource注入或JDBC连接执行）与结果集映射（Map/List/自定义映射）。
  - 基本监控指标（耗时、行数、出错率）与日志审计（模板ID、调用方、签名）。
  - 单元测试覆盖与基准测试基线。
- Should
  - 结果集分页、游标模式。
  - 语法级扩展（窗口函数、子查询、CTE）。
  - 查询级别限流/超时/重试策略。
  - 简单优化器（条件下推、选择性拼接、方言hint）。
  - SQL/结果缓存（按模板+参数hash）。
- Could
  - Server模式（HTTP API），支持多租户配额与鉴权。
  - 可插拔的安全白名单与敏感词扫描。
  - 模板版本管理与灰度。
  - 与JMeter集成的压测脚本生成器。

## 5. 非功能需求
- 性能：单次简单聚合查询p95 < 80ms（不含网络与DB本身延迟，基于本地直连与Warm cache）；复杂多表join p95 < 300ms（同前提，按库差异分级）；QPS目标按里程碑优化。
- 可靠性：出错可观测、错误信息可定位；异常不泄漏敏感信息。
- 可用性：SDK集成简单；JSON模板字段命名清晰、文档化；错误提示可读。
- 安全：全参数化；模板白名单（表/列/函数）；最大行数与超时限制；审计日志。
- 可扩展：新增方言、函数、操作符、数据源类型时无需大改。

## 6. 验收标准与KPI
- 功能验收：用户故事覆盖率≥90%，核心Must功能全部可用。
- 质量：关键路径单元测试覆盖率≥80%；核心性能基准达到目标。
- 交付：完成使用文档与示例模板；接入示例项目（SDK方式）。

## 7. 用户故事（节选）
- 作为数据分析师，我希望用JSON模板快速定义“近7天活跃用户数按地区分组”的报表，并能分页查看明细。
- 作为后端工程师，我希望在不定义实体的前提下，用对象DSL拼装一个有3个维表join、带窗口函数的查询。
- 作为平台工程师，我希望限制单次查询的最大扫描分区与超时时间，并记录调用审计信息。

## 8. 范围边界
- 不做：可视化大屏、权限体系的全栈实现、SQL编辑器UI（可在后续Server化里程碑规划）。
- 做：引擎能力与治理支撑，SDK为主，Server模式为辅（可选里程碑）。

## 9. 里程碑
- M1：单方言（MySQL或ClickHouse）+ JSON模板 + 参数化执行 + 基础校验 + 单测/基准
- M2：对象DSL + 元数据缓存 + 监控指标 + 简单优化器 + 压测方案
- M3：多方言适配 + Server模式（HTTP）+ 模板版本与审计 + 缓存加强